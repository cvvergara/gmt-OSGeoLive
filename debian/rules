#! /usr/bin/make -f

# Some special build options
ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
   CFLAGS += -g -O0
   LDFLAGS += -g
else
   CFLAGS += -O2
endif

CFLAGS += $(CPPFLAGS)

ifneq (,$(findstring verbose,$(DEB_BUILD_OPTIONS)))
   DH_VERBOSE=1
   export DH_VERBOSE
endif

UPSTREAM_VERSION=$(shell dpkg-parsechangelog | sed -ne 's/^Version: \(.*\)-.*/\1/p' | sed -e 's/~.*//; s/^[0-9]://')

BUILDDIR = $(CURDIR)/debian/build
DESTDIR	= $(CURDIR)/debian/tmp

CMAKE_OPTS = -DCMAKE_BUILD_TYPE=RelWithDebInfo \
             -DCMAKE_C_FLAGS="-fstrict-aliasing $(CFLAGS)" \
             -DCMAKE_INSTALL_PREFIX=/usr \
             -DDCW_ROOT=/usr/share/gmt-dcw \
             -DGSHHG_ROOT=/usr/share/gmt-gshhg \
             -DNETCDF_ROOT=/usr \
             -DFFTW3_ROOT=/usr \
             -DGDAL_ROOT=/usr \
             -DPCRE_ROOT=/usr \
             -DFLOCK=on \
             -DGMT_INSTALL_MODULE_LINKS=off \
             -DGMT_INSTALL_TRADITIONAL_FOLDERNAMES=off \
             -DLICENSE_RESTRICTED=LGPL 

%:
	dh $@ --buildsystem cmake \
		--sourcedirectory=$(CURDIR) --builddirectory=$(BUILDDIR) \
		--parallel

override_dh_auto_clean:
	rm -rf $(BUILDDIR) $(DESTDIR)
	dh_auto_clean

override_dh_auto_build-arch:
	mkdir $(BUILDDIR) || true 
	cd $(BUILDDIR) && cmake $(CMAKE_OPTS) ../..
	$(MAKE) -C $(BUILDDIR) CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)" 

override_dh_auto_build-indep:
	$(MAKE) -C $(BUILDDIR) docs_man docs_html docs_pdf

override_dh_auto_install:
	DESTDIR=$(DESTDIR) $(MAKE) -C $(BUILDDIR) install
	# remove duplicated stuff
#	rm -rf debian/tmp/usr/share/conf \
#	       debian/tmp/usr/share/cpt \
#	       debian/tmp/usr/share/custom \
#	       debian/tmp/usr/share/dbase \
#	       debian/tmp/usr/share/mgd77 \
#	       debian/tmp/usr/share/mgg \
#	       debian/tmp/usr/share/pattern \
#	       debian/tmp/usr/share/pslib \
#	       debian/tmp/usr/share/time \
#	       debian/tmp/usr/share/tools \
#	       debian/tmp/usr/share/VERSION \
#	       debian/tmp/usr/share/x2sys
	dh_auto_install

	# Uncompress examples stuff 
	#find  $(CURDIR)/debian/gmt-examples/usr/share/doc/gmt-examples/examples -name "*.gz" -exec gunzip {} \;
	# Remove +x 
	#find  $(CURDIR)/debian/gmt-examples/usr/share/doc/gmt-examples/examples -name "*.bat" -exec chmod -x {} \;

	# Remove executable bit from shell includes
	chmod -x debian/tmp/usr/share/gmt/tools/gmt_functions.sh \
	         debian/tmp/usr/share/gmt/tools/gmt_aliases.csh

	# Remove embedded sphinx copies of JS libraries in favor of packaged ones
	rm -f debian/tmp/usr/share/doc/gmt/html/_static/jquery.js \
	      debian/tmp/usr/share/doc/gmt/html/_static/underscore.js

	# Remove empty directory
	rmdir debian/tmp/usr/share/doc/gmt/html/_images/math/

	# Fix bash-completion installation
	mkdir -p debian/tmp/usr/share/bash-completion/completions
	mv debian/tmp/usr/etc/bash_completion.d/gmt debian/tmp/usr/share/bash-completion/completions
	rm -rf debian/tmp/usr/etc/bash_completion.d
	rmdir debian/tmp/usr/etc/

	# Strip RPATH
	chrpath --delete \
	        debian/tmp/usr/lib/*/gmt/plugins/supplements.so \
	        debian/tmp/usr/lib/*/lib*.so.*.* \
	        debian/tmp/usr/bin/gmt

	# Recompress the manpages to not use timestamped gzip
	for section in 1 3 5; do\
		for manpage in debian/tmp/usr/share/doc/gmt/man/man$${section}/*.$${section}.gz; do \
			gunzip $${manpage} && gzip -n `echo $${manpage} | sed 's/.gz$$//'` ; \
		done; \
	done

#	$(MAKE) -C build/src/mex DESTDIR=$(DESTDIR) install
#	-find $(DESTDIR)/usr/lib/octave -name "*.mex" -exec rename 's/\.mex/.oct/' {} \;
	
	# Okay, we still have to move the documentation (the trick above does
	# not work because the Makefile would try to overwrite the link with
	# a directory). So move the docs and link them to where GMT will look
	# for them. 
#	mv $(DESTDIR)/usr/lib/gmt/share/doc/gmt $(DESTDIR)/usr/share/doc/
#	ln -fs ../../../share/doc/gmt $(DESTDIR)/usr/lib/gmt/share/doc/gmt
	
	# Configuration files are still at the wrong place, let's fix this
#	mv $(DESTDIR)/usr/share/gmt/conf/*.conf $(DESTDIR)/etc/gmt/
#	install -m644 debian/coastline.conf $(DESTDIR)/etc/gmt/
#	for file in $(DESTDIR)/etc/gmt/*.conf; do \
#		ln -fs /etc/gmt/`basename $$file` $(DESTDIR)/usr/share/gmt/`basename $$file`; \
#	done
	
	# GMT wrapper does not help in /usr/lib/gmt/bin (not in path by default)
	# So: Move it to /usr/bin and patch it a bit locally to alter the PATH var.
	# Also use 'pager' instead of more as default pager in the script.
#	sed -e 's/^exec /PATH=\$$PATH:\$${exec_prefix}\/bin exec /' \
#	    -e 's/:-more/:-pager/' \
#	    	$(DESTDIR)/usr/lib/gmt/bin/GMT >$(DESTDIR)/usr/bin/GMT
#	rm -f $(DESTDIR)/usr/lib/gmt/bin/GMT
	
	# Move the manpages directory into the right place...
#	for section in 1 3 5; do \
#		mkdir -p $(DESTDIR)/usr/share/man/man$${section}; \
#		for manpage in $(DESTDIR)/usr/lib/gmt/share/man/man$${section}/*.$${section}; do \
#			sed -e "s/^\.TH \(.*\) $${section}/\.TH \1 $${section}gmt/" $${manpage}|gzip \
#			       >$(DESTDIR)/usr/share/man/man$${section}/`basename $${manpage}`gmt.gz; \
#			rm -f $${manpage}; \
#		done; \
#	done
#	rm -rf $(DESTDIR)/usr/share/gmt/man
	
override_dh_install:
	dh_install --list-missing

override_dh_installman:
	dh_installman

	# Fix gmt_shell_functions.sh man page installation
	mv debian/gmt/usr/share/man/sh/man1/gmt_shell_functions.1 \
	   debian/gmt/usr/share/man/man1/gmt_shell_functions.sh.1
	rm -rf debian/gmt/usr/share/man/sh/

override_dh_compress:
	# Don't compress the pdf files needed for the gmt-doc-pdf package
	dh_compress -X.pdf

override_dh_strip:
	dh_strip --dbg-package=gmt-dbg

override_dh_makeshlibs:
	dh_makeshlibs -- -v$(UPSTREAM_VERSION)

