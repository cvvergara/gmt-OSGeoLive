#! /usr/bin/make -f

#CFLAGS := -fPIC -ansi

# Some special build options
ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
   CFLAGS += -g -O0
   LDFLAGS += -g
else
   CFLAGS += -O2
endif

ifneq (,$(findstring verbose,$(DEB_BUILD_OPTIONS)))
   DH_VERBOSE=1
   export DH_VERBOSE
endif

build:		build-stamp
install:	install-stamp
binary:		binary-arch binary-indep

BUILDDIR	:= $(CURDIR)/debian/build
DESTDIR		:= $(BUILDDIR)/debian/tmp

build-stamp: 
	dh_testdir
	dh_prep
#		--enable-shared $(PATHCONFIG) --disable-mex --enable-netcdf=/usr \
#		--enable-octave \
#	    --enable-mex-mdir=$(shell octave-config --m-site-dir) \
#		--enable-mex-xdir=$(shell octave-config --oct-site-dir) 
	mkdir debian/build || true 
	cd debian/build && cmake ../..
	$(MAKE) -C debian/build CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)" 

install-stamp: build-stamp
	dh_testdir
	dh_testroot
	
	DESTDIR=$(DESTDIR) $(MAKE) -C debian/build install
	# remove duplicated stuff
	rm -rf debian/tmp/usr/share/conf \
		debian/tmp/usr/share/cpt \
		debian/tmp/usr/share/custom \
		debian/tmp/usr/share/dbase \
		debian/tmp/usr/share/mgd77 \
		debian/tmp/usr/share/mgg \
		debian/tmp/usr/share/pattern \
		debian/tmp/usr/share/pslib \
		debian/tmp/usr/share/time \
		debian/tmp/usr/share/tools \
		debian/tmp/usr/share/VERSION \
		debian/tmp/usr/share/x2sys

#	$(MAKE) -C build/src/mex DESTDIR=$(DESTDIR) install
#	-find $(DESTDIR)/usr/lib/octave -name "*.mex" -exec rename 's/\.mex/.oct/' {} \;
	
	# Okay, we still have to move the documentation (the trick above does
	# not work because the Makefile would try to overwrite the link with
	# a directory). So move the docs and link them to where GMT will look
	# for them. 
#	mv $(DESTDIR)/usr/lib/gmt/share/doc/gmt $(DESTDIR)/usr/share/doc/
#	ln -fs ../../../share/doc/gmt $(DESTDIR)/usr/lib/gmt/share/doc/gmt
	
	# Configuration files are still at the wrong place, let's fix this
#	mv $(DESTDIR)/usr/share/gmt/conf/*.conf $(DESTDIR)/etc/gmt/
#	install -m644 debian/coastline.conf $(DESTDIR)/etc/gmt/
#	for file in $(DESTDIR)/etc/gmt/*.conf; do \
#		ln -fs /etc/gmt/`basename $$file` $(DESTDIR)/usr/share/gmt/`basename $$file`; \
#	done
	
	# GMT wrapper does not help in /usr/lib/gmt/bin (not in path by default)
	# So: Move it to /usr/bin and patch it a bit locally to alter the PATH var.
	# Also use 'pager' instead of more as default pager in the script.
#	sed -e 's/^exec /PATH=\$$PATH:\$${exec_prefix}\/bin exec /' \
#	    -e 's/:-more/:-pager/' \
#	    	$(DESTDIR)/usr/lib/gmt/bin/GMT >$(DESTDIR)/usr/bin/GMT
#	rm -f $(DESTDIR)/usr/lib/gmt/bin/GMT
	
	# Move the manpages directory into the right place...
#	for section in 1 3 5; do \
#		mkdir -p $(DESTDIR)/usr/share/man/man$${section}; \
#		for manpage in $(DESTDIR)/usr/lib/gmt/share/man/man$${section}/*.$${section}; do \
#			sed -e "s/^\.TH \(.*\) $${section}/\.TH \1 $${section}gmt/" $${manpage}|gzip \
#			       >$(DESTDIR)/usr/share/man/man$${section}/`basename $${manpage}`gmt.gz; \
#			rm -f $${manpage}; \
#		done; \
#	done
#	rm -rf $(DESTDIR)/usr/share/gmt/man
	
	touch $@

binary-arch: install-stamp
	dh_testdir -a
	dh_testroot -a
	dh_install --list-missing 
	dh_installchangelogs -a
	dh_installchangelogs -pgmt ChangeLog
	dh_installdocs -a
	dh_installexamples -a
	dh_installmenu -a
	dh_installman -a
	dh_strip -a
	dh_link -a
	dh_compress -a -X.pdf
	dh_fixperms -a
	dh_makeshlibs -a
	dh_shlibdeps -a 
	dh_installdeb -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a
	

binary-indep: install-stamp
	dh_testdir -i
	dh_testroot -i
	dh_install --list-missing 
	dh_installchangelogs -i
	dh_installdocs -i
	dh_installexamples -i
	dh_installmenu -i
	dh_installman -i
	dh_strip -i
	dh_link -i
	dh_compress -i -X.pdf
	# Uncompress examples stuff 
	find  $(CURDIR)/debian/gmt-examples/usr/share/doc/gmt-examples/examples -name "*.gz" -exec gunzip {} \;
	# Remove +x 
	find  $(CURDIR)/debian/gmt-examples/usr/share/doc/gmt-examples/examples -name "*.bat" -exec chmod -x {} \;
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

clean:
	dh_testdir
	dh_testroot
	rm -f install-stamp build-stamp
	rm -rf $(BUILDDIR) $(DESTDIR)
	dh_clean
